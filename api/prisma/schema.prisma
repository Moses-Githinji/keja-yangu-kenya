generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id                       String                  @id @default(cuid())
  firstName                String
  lastName                 String
  email                    String                  @unique
  phone                    String?                 @unique
  password                 String
  role                     String                  @default("USER")
  isActive                 Boolean                 @default(true)
  isVerified               Boolean                 @default(false)
  avatar                   String?
  dateOfBirth              DateTime?
  gender                   String?
  nationality              String?
  idNumber                 String?                 @unique
  passportNumber           String?
  bio                      String?
  emailVerificationCode    String?
  emailVerificationExpires DateTime?
  phoneVerificationCode    String?
  phoneVerificationExpires DateTime?
  createdAt                DateTime                @default(now())
  updatedAt                DateTime                @updatedAt
  loginAttempts            Int                     @default(0)
  lockUntil                DateTime?
  lastLogin                DateTime?
  isOnline                 Boolean                 @default(false)
  lastSeen                 DateTime?               @default(now())
  agentProfile             AgentProfile?
  contentCreatorProfile    ContentCreatorProfile?
  agentChats               Chat[]                  @relation("AgentChats")
  userChats                Chat[]                  @relation("UserChats")
  facebookAuth             FacebookAuth?
  googleAuth               GoogleAuth?
  sentMessages             Message[]
  notifications            Notification[]
  payments                 Payment[]
  agentProperties          Property[]              @relation("AgentProperties")
  properties               Property[]
  agentInquiries           PropertyInquiry[]       @relation("AgentInquiries")
  userInquiries            PropertyInquiry[]       @relation("UserInquiries")
  preferences              UserPreferences?
  favorites                UserPropertyFavorites[]
  inquiries                UserPropertyInquiries[]
  propertyEarnings         PropertyEarnings[]
  creatorPayouts           CreatorPayouts[]
  adRevenue                AdRevenue[]
  adImpressions            AdImpression[]
  securityLogs             SecurityLog[]
  guestBookings            ShortTermBooking[]    @relation("GuestBookings")
  hostBookings             ShortTermBooking[]    @relation("HostBookings")
  authoredReviews          BookingReview[]       @relation("ReviewAuthor")
  receivedReviews          BookingReview[]       @relation("ReviewRecipient")

  @@index([phone])
  @@map("users")
}

model UserPreferences {
  id                 String         @id @default(cuid())
  userId             String         @unique
  propertyTypes      String         // Comma-separated values
  locations          String         // Comma-separated values
  emailNotifications Boolean        @default(true)
  smsNotifications   Boolean        @default(true)
  pushNotifications  Boolean        @default(true)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  user               User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model AgentProfile {
  id               String    @id @default(cuid())
  userId           String    @unique
  company          String?
  licenseNumber    String?   @unique
  experience       Int?
  specializations  String    // Comma-separated values
  bio              String?
  website          String?
  isVerified       Boolean   @default(false)
  verificationDate DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("agent_profiles")
}

model GoogleAuth {
  id           String   @id @default(cuid())
  userId       String   @unique
  googleId     String   @unique
  email        String
  accessToken  String
  refreshToken String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("google_auth")
}

model FacebookAuth {
  id          String   @id @default(cuid())
  userId      String   @unique
  facebookId  String   @unique
  email       String
  accessToken String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("facebook_auth")
}

model Property {
  id                String                  @id @default(cuid())
  title             String
  description       String
  propertyType      String
  listingType       String
  status            String                  @default("ACTIVE")
  address           String
  city              String
  county            String
  neighborhood      String?
  postalCode        String?
  latitude          Float
  longitude         Float
  price             Float
  currency          String                  @default("KES")
  priceType         String                  @default("FIXED")
  rentPeriod        String?
  deposit           Float?
  bedrooms          Int?
  bathrooms         Int?
  area              String?
  areaSize          Float
  areaUnit          String                  @default("SQM")
  yearBuilt         Int?
  floors            Int?
  parkingSpaces     Int?
  features          String                  // Comma-separated values
  amenities         String                  // Comma-separated values
  nearbyAmenities   String                  // Comma-separated values
  ownerId           String
  agentId           String?
  isFeatured        Boolean                 @default(false)
  isVerified        Boolean                 @default(false)
  isPremium         Boolean                 @default(false)
  slug              String                  @unique
  views             Int                     @default(0)
  inquiryCount      Int                     @default(0)
  geocodedAddress   String?
  
  // Utilities & Infrastructure
  waterSource       String?
  backupPower       String?
  fiberProviders    String?                 // Comma-separated list
  hasSolarWaterHeating Boolean              @default(false)
  
  // Security
  securityFeatures  String?                 // Comma-separated list
  
  // Financial & Legal
  serviceCharge     Float?
  depositMonths     Int?
  legalStatus       String?                 // e.g., "Title Deed Ready", "Leasehold"
  
  // Investment Info
  projectedYield    Float?                  // Percentage
  annualAppreciation Float?                 // Percentage
  
  // Media
  virtualTourUrl    String?
  floorPlanUrl      String?

  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  listedAt          DateTime                @default(now())
  soldAt            DateTime?
  chats             Chat[]
  payments          Payment[]
  priceHistory      PriceHistory[]
  agent             User?                   @relation("AgentProperties", fields: [agentId], references: [id])
  owner             User                    @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  documents         PropertyDocument[]
  images            PropertyImage[]
  propertyInquiries PropertyInquiry[]
  showingTimes      ShowingTime[]
  favorites         UserPropertyFavorites[]
  inquiries         UserPropertyInquiries[]
  earnings          PropertyEarnings[]
  adImpressions     AdImpression[]
  adRevenue         AdRevenue[]
  shortTermBookings ShortTermBooking[]
  calendar          PropertyCalendar[]
  propertyViews     PropertyView[]

  @@index([ownerId])
  @@index([agentId])
  @@index([propertyType])
  @@index([listingType])
  @@index([status])
  @@index([city])
  @@index([county])
  @@index([neighborhood])
  @@index([price])
  @@index([createdAt])
  @@index([isPremium])
  @@map("properties")
}

model PropertyView {
  id         String   @id @default(cuid())
  propertyId String
  sessionId  String
  createdAt  DateTime @default(now())
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("property_views")
}

model PropertyImage {
  id         String   @id @default(cuid())
  propertyId String
  url        String
  altText    String?
  isPrimary  Boolean  @default(false)
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("property_images")
}

model PropertyDocument {
  id         String   @id @default(cuid())
  propertyId String
  url        String
  name       String
  type       String
  size       Int?
  createdAt  DateTime @default(now())
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("property_documents")
}

model PriceHistory {
  id         String   @id @default(cuid())
  propertyId String
  price      Float
  currency   String
  changeDate DateTime @default(now())
  reason     String?
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("price_history")
}

model ShowingTime {
  id          String   @id @default(cuid())
  propertyId  String
  date        DateTime
  startTime   String
  endTime     String
  isAvailable Boolean  @default(true)
  notes       String?
  createdAt   DateTime @default(now())
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("showing_times")
}

model UserPropertyFavorites {
  id         String   @id @default(cuid())
  userId     String
  propertyId String
  createdAt  DateTime @default(now())
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, propertyId])
  @@map("user_property_favorites")
}

model UserPropertyInquiries {
  id                String   @id @default(cuid())
  userId            String
  propertyId        String
  message           String
  contactPreference String   @default("EMAIL")
  isRead            Boolean  @default(false)
  createdAt         DateTime @default(now())
  property          Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_property_inquiries")
}

model Chat {
  id         String    @id @default(cuid())
  userId     String
  agentId    String
  propertyId String?
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  agent      User      @relation("AgentChats", fields: [agentId], references: [id], onDelete: Cascade)
  property   Property? @relation(fields: [propertyId], references: [id])
  user       User      @relation("UserChats", fields: [userId], references: [id], onDelete: Cascade)
  messages   Message[]

  @@unique([userId, agentId, propertyId])
  @@map("chats")
}

model Message {
  id          String   @id @default(cuid())
  chatId      String
  senderId    String
  content     String
  messageType String   @default("TEXT")
  isRead      Boolean  @default(false)
  isDelivered Boolean  @default(false)
  deliveredAt DateTime?
  createdAt   DateTime @default(now())
  chat        Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender      User     @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model PropertyInquiry {
  id                String   @id @default(cuid())
  propertyId        String
  userId            String
  agentId           String
  message           String
  contactPreference String   @default("EMAIL")
  isRead            Boolean  @default(false)
  status            String   @default("PENDING")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  agent             User     @relation("AgentInquiries", fields: [agentId], references: [id], onDelete: Cascade)
  property          Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user              User     @relation("UserInquiries", fields: [userId], references: [id], onDelete: Cascade)

  @@map("property_inquiries")
}

model Payment {
  id            String        @id @default(cuid())
  userId        String
  propertyId    String?
  amount        Float
  currency      String        @default("KES")
  provider      String
  transactionRef String       @unique
  status        String        @default("PENDING")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  property      Property?     @relation(fields: [propertyId], references: [id])
  logs          PaymentLog[]

  @@map("payments")
}

model PaymentLog {
  id         String   @id @default(cuid())
  paymentId  String
  action     String
  details    String?
  timestamp  DateTime @default(now())
  payment    Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@map("payment_logs")
}

model Notification {
  id        String             @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  status    String             @default("UNREAD")
  metadata  String?            // JSON as string
  readAt    DateTime?
  createdAt DateTime           @default(now())
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@map("notifications")
}

// New models for monetization system

model ContentCreatorProfile {
  id                  String                  @id @default(cuid())
  userId              String                  @unique
  isEnrolled          Boolean                 @default(false)
  enrollmentDate      DateTime?
  enrollmentStatus    String                  @default("PENDING")
  totalEarnings       Float                   @default(0)
  totalPayouts        Float                   @default(0)
  availableBalance    Float                   @default(0)
  viewRate            Float                   @default(0.01) // KES per view
  inquiryRate         Float                   @default(0.50) // KES per inquiry
  premiumListingRate  Float                   @default(0.10) // 10% of premium fee
  adRevenueRate       Float                   @default(0.70) // 70% of ad revenue
  minimumPayout       Float                   @default(100) // Minimum KES for payout
  taxId               String?                 @unique
  bankAccount         String?                 // JSON as string
  mpesaNumber         String?
  payoutMethod        String                  @default("MPESA")
  isTaxExempt         Boolean                 @default(false)
  taxRate             Float                   @default(0.16) // 16% VAT
  complianceScore     Int                     @default(100)
  lastComplianceCheck DateTime?
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  user                User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  earnings            PropertyEarnings[]
  payouts             CreatorPayouts[]
  adRevenue           AdRevenue[]
  violations          ComplianceViolation[]

  @@map("content_creator_profiles")
}

model PropertyEarnings {
  id              String                @id @default(cuid())
  propertyId      String
  creatorId       String
  earningsType    String
  amount          Float
  currency        String                @default("KES")
  views           Int                   @default(0)
  inquiries       Int                   @default(0)
  adImpressions   Int                   @default(0)
  calculationDate DateTime              @default(now())
  isProcessed     Boolean               @default(false)
  processedAt     DateTime?
  createdAt       DateTime              @default(now())
  property        Property              @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  creator         ContentCreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  User            User?                 @relation(fields: [userId], references: [id])
  userId          String?

  @@unique([propertyId, creatorId, calculationDate])
  @@map("property_earnings")
}

model CreatorPayouts {
  id             String                @id @default(cuid())
  creatorId      String
  amount         Float
  currency       String                @default("KES")
  method         String
  status         String                @default("PENDING")
  transactionId  String?               @unique
  bankReference  String?
  mpesaReference String?
  processedAt    DateTime?
  failureReason  String?
  metadata       String?               // JSON as string
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  creator        ContentCreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  User           User?                 @relation(fields: [userId], references: [id])
  userId         String?

  @@map("creator_payouts")
}

model AdRevenue {
  id          String                @id @default(cuid())
  creatorId   String
  propertyId  String?
  adType      String
  impressions Int
  clicks      Int
  revenue     Float
  currency    String                @default("KES")
  cpm         Float // Cost per mille (per 1000 impressions)
  cpc         Float // Cost per click
  date        DateTime              @default(now())
  isProcessed Boolean               @default(false)
  processedAt DateTime?
  createdAt   DateTime              @default(now())
  creator     ContentCreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  property    Property?             @relation(fields: [propertyId], references: [id])
  User        User?                 @relation(fields: [userId], references: [id])
  userId      String?

  @@map("ad_revenue")
}

model AdImpression {
  id             String         @id @default(cuid())
  propertyId     String
  adType         String
  impressionType String
  revenue        Float
  currency       String         @default("KES")
  timestamp      DateTime       @default(now())
  userAgent      String?
  ipAddress      String?
  location       String?        // JSON as string
  property       Property?      @relation(fields: [propertyId], references: [id])
  User           User?          @relation(fields: [userId], references: [id])
  userId         String?

  @@map("ad_impressions")
}

model ComplianceViolation {
  id              String                @id @default(cuid())
  creatorId       String
  violationType   String
  severity        String
  description     String
  evidence        String?               // JSON as string
  isResolved      Boolean               @default(false)
  resolvedAt      DateTime?
  resolutionNotes String?
  penaltyAmount   Float                 @default(0)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  creator         ContentCreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@map("compliance_violations")
}

// Security models for payment protection
model SecurityLog {
  id        String   @id @default(cuid())
  type      String
  severity  String   @default("LOW") // LOW, MEDIUM, HIGH, CRITICAL
  userId    String?
  ipAddress String
  userAgent String?
  endpoint  String
  method    String
  details   String?  // JSON as string
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([ipAddress])
  @@index([type])
  @@index([createdAt])
  @@map("security_logs")
}

model BlockedIP {
  id         String   @id @default(cuid())
  ipAddress  String   @unique
  reason     String
  blockedBy  String?
  blockedAt  DateTime @default(now())
  expiresAt  DateTime?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("blocked_ips")
}

// Short-term rental models
model ShortTermBooking {
  id            String            @id @default(cuid())
  propertyId    String
  guestId       String
  hostId        String
  checkIn       DateTime
  checkOut      DateTime
  guests        Int               @default(1)
  totalAmount   Float
  currency      String            @default("KES")
  status        String            @default("PENDING") // PENDING, CONFIRMED, CANCELLED, COMPLETED
  bookingCode   String            @unique
  specialRequests String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  confirmedAt   DateTime?
  cancelledAt   DateTime?
  completedAt   DateTime?
  property      Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  guest         User              @relation("GuestBookings", fields: [guestId], references: [id], onDelete: Cascade)
  host          User              @relation("HostBookings", fields: [hostId], references: [id], onDelete: Cascade)
  payments      BookingPayment[]
  reviews       BookingReview[]

  @@index([propertyId])
  @@index([guestId])
  @@index([hostId])
  @@index([status])
  @@index([checkIn, checkOut])
  @@map("short_term_bookings")
}

model BookingPayment {
  id         String            @id @default(cuid())
  bookingId  String
  amount     Float
  currency   String            @default("KES")
  provider   String
  status     String            @default("PENDING")
  reference  String            @unique
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  booking    ShortTermBooking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("booking_payments")
}

model BookingReview {
  id         String            @id @default(cuid())
  bookingId  String
  reviewerId String
  revieweeId String
  rating     Int               // 1-5 stars
  title      String?
  comment    String
  reviewType String            // GUEST_TO_HOST or HOST_TO_GUEST
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  booking    ShortTermBooking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  reviewer   User              @relation("ReviewAuthor", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewee   User              @relation("ReviewRecipient", fields: [revieweeId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([reviewerId])
  @@index([revieweeId])
  @@map("booking_reviews")
}

model PropertyCalendar {
  id           String   @id @default(cuid())
  propertyId   String
  date         DateTime
  isAvailable  Boolean  @default(true)
  price        Float?
  currency     String   @default("KES")
  minStay      Int      @default(1)
  maxStay      Int?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  property     Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, date])
  @@index([propertyId])
  @@index([date])
  @@map("property_calendar")
}